# 画面設計書とAPI設計書のギャップ分析

## 概要

画面設計書（docs/screens）で使用されているAPIと、NextAuth統合版のAPI設計書（docs/api/endpoints）との間のギャップを分析した結果をまとめます。

## 1. 認証関連画面のギャップ

### 1.1 根本的な認証方式の違い

| 項目               | 画面設計書の想定   | NextAuth版API設計    | 対応策                 |
| ------------------ | ------------------ | -------------------- | ---------------------- |
| 認証方式           | パスワード認証     | マジックリンク認証   | 画面設計の見直しが必要 |
| ログイン           | email + password   | emailのみ            | ログイン画面の簡素化   |
| 新規登録           | 即時アカウント作成 | 初回ログイン時に作成 | 登録フローの変更       |
| パスワードリセット | 必要               | 不要                 | 画面の削除             |

### 1.2 不足しているAPI

画面設計書で使用されているが、NextAuth版API設計書に存在しないAPI：

1. **メールアドレス重複チェック**

   - エンドポイント: `GET /api/v1/auth/check-email`
   - 用途: 新規登録時のリアルタイムバリデーション
   - NextAuthでは不要（マジックリンク方式のため）

2. **パスワードリセットトークン検証**
   - エンドポイント: `GET /api/v1/auth/verify-reset-token`
   - 用途: リセット画面表示前の検証
   - NextAuthでは不要（パスワードレス）

### 1.3 レスポンス形式の違い

**画面設計書の期待値**:

```typescript
// ログイン成功時
{
  user: { id, email, displayName, emailVerified },
  session: { token, expiresAt }
}
```

**NextAuth版の実際**:

```typescript
// セッション取得
{
  user: { email, id, userId },
  expires: string
}
```

## 2. ユーザー管理関連のギャップ

### 2.1 ホーム画面のAPI使用

| 項目           | 画面設計書             | API設計書                | 整合性        |
| -------------- | ---------------------- | ------------------------ | ------------- |
| エンドポイント | `GET /api/v1/users/me` | `GET /api/v1/users/me`   | ✅ OK         |
| 用途           | ユーザー情報表示       | ドメインユーザー情報取得 | ✅ OK         |
| レスポンス     | 基本情報のみ           | 詳細情報含む             | ✅ 互換性あり |

### 2.2 セッション管理の違い

- 画面設計書: Bearer Token認証を想定
- NextAuth版: Cookie-based認証
- 影響: APIクライアントの実装方法が変わる

## 3. 推奨される対応

### 3.1 画面設計の更新が必要な箇所

1. **ログイン画面**

   - パスワード入力フィールドを削除
   - メールアドレスのみの入力に変更
   - 「マジックリンクを送信」ボタンに変更

2. **新規登録画面**

   - 削除または大幅な簡素化
   - 初回ログイン時のプロフィール設定画面として再設計

3. **パスワードリセット関連画面**

   - 完全に削除（forgot-password.md, reset-password.md）

4. **メール確認画面（新規作成）**
   - `/auth/verify-request` - マジックリンク送信後の確認画面
   - `/auth/error` - 認証エラー画面

### 3.2 API実装の調整

1. **ホーム画面のAPI**

   - 現状のまま使用可能
   - ただし、認証方式の変更に対応したクライアント実装が必要

2. **セッション管理**
   - useSession() フックの使用
   - Bearer Tokenヘッダーの削除

### 3.3 エラーハンドリングの統一

| エラータイプ       | 画面設計書                 | NextAuth版での対応     |
| ------------------ | -------------------------- | ---------------------- |
| 401 Unauthorized   | ログイン画面へリダイレクト | NextAuthのsignIn()へ   |
| 403 Forbidden      | 権限エラー表示             | 同じ                   |
| セッション期限切れ | 再ログイン促す             | 自動的にsignInページへ |

## 4. 移行計画

### Phase 1: 画面設計書の更新

1. 認証フローをマジックリンク方式に更新
2. 不要な画面の削除マーク
3. 新規画面の追加

### Phase 2: API仕様の微調整

1. ホーム画面用APIのレスポンス調整（必要に応じて）
2. エラーレスポンスの統一

### Phase 3: 実装ガイドの作成

1. NextAuth統合のベストプラクティス
2. クライアント側の実装例
3. 移行時の注意点

## 5. 結論

画面設計書とNextAuth版API設計書の間には、認証方式の根本的な違いによる大きなギャップが存在します。主な対応として：

1. **認証関連画面の再設計が必要**
2. **ユーザー管理APIは概ね互換性あり**
3. **クライアント実装の認証方式変更が必要**

これらの変更により、よりセキュアでユーザーフレンドリーな認証システムを実現できます。
