# パスワード再設定

## 1. 基本情報

- **画面ID**: SCREEN_AUTH_004
- **パス**: /auth/reset-password
- **作成日**: 2025-06-24
- **更新日**: 2025-06-24
- **ステータス**: 設計中
- **担当者**: @claude

## 2. 画面概要

### 目的

パスワードリセットメールから遷移してきたユーザーが、新しいパスワードを設定するための画面。有効なリセットトークンを持つユーザーのみアクセス可能。

### ユーザーストーリー

As a パスワードリセット中のユーザー
I want to 新しいパスワードを設定する
So that 新しいパスワードでログインできるようになる

### 前提条件・制約

- **アクセス権限**: 有効なリセットトークンを持つユーザーのみ
- **事前条件**:
  - パスワードリセットメールからのアクセス
  - トークンが有効期限内（1時間）
  - トークンが未使用
- **画面の制約事項**:
  - トークンは一度のみ使用可能
  - パスワードは最低8文字、大文字・小文字・数字を含む
  - 設定完了後は自動的にログイン画面へリダイレクト

## 3. UI設計

### 画面構成

```
┌─────────────────────────────────────┐
│       🍳 食材管理アプリ              │
├─────────────────────────────────────┤
│                                     │
│      新しいパスワードの設定          │
│                                     │
│   新しいパスワードを入力してくださ   │
│   い。                              │
│                                     │
│   ┌─────────────────────────┐      │
│   │ 新しいパスワード        │👁     │
│   └─────────────────────────┘      │
│   ・8文字以上                       │
│   ・大文字・小文字・数字を含む      │
│                                     │
│   ┌─────────────────────────┐      │
│   │ パスワード（確認）      │👁     │
│   └─────────────────────────┘      │
│                                     │
│   [  パスワードを変更  ]            │
│                                     │
└─────────────────────────────────────┘

【エラー時の画面】
┌─────────────────────────────────────┐
│       🍳 食材管理アプリ              │
├─────────────────────────────────────┤
│                                     │
│         ⚠️ エラー                   │
│                                     │
│   このリンクは無効または期限切れで   │
│   す。                              │
│                                     │
│   もう一度パスワードリセットをお試   │
│   しください。                      │
│                                     │
│   [ パスワードリセット画面へ ]      │
│   [     ログイン画面へ     ]       │
│                                     │
└─────────────────────────────────────┘
```

### コンポーネント構成

- **ヘッダー**: アプリロゴとタイトル
- **メイン**:
  - 通常時：
    - 説明文
    - 新パスワード入力フォーム
    - パスワード確認入力フォーム
    - パスワード要件の表示
    - 変更ボタン
  - エラー時：
    - エラーメッセージ
    - パスワードリセット画面へのリンク
    - ログイン画面へのリンク
- **フッター**: なし（シンプルな認証画面のため）

### レスポンシブ対応

- **モバイル (< 768px)**: フォーム幅100%、パディング16px
- **タブレット (768px - 1024px)**: フォーム幅400px、中央配置
- **デスクトップ (> 1024px)**: フォーム幅400px、中央配置

## 4. 機能仕様

### アクション一覧

| アクション               | トリガー                   | 処理内容                               | 結果                                                   |
| ------------------------ | -------------------------- | -------------------------------------- | ------------------------------------------------------ |
| トークン検証             | 画面表示時                 | トークンの有効性確認API呼び出し        | 有効：フォーム表示<br>無効：エラー画面表示             |
| パスワード変更           | 変更ボタンクリック         | パスワード更新API呼び出し              | 成功：ログイン画面へ遷移<br>失敗：エラーメッセージ表示 |
| パスワード表示切替       | 目アイコンクリック         | パスワードの表示/非表示切替            | 入力内容が見える/隠れる                                |
| パスワード強度チェック   | パスワード入力             | リアルタイムで要件を満たしているか表示 | 要件を満たした項目に✓表示                              |
| パスワードリセット画面へ | リンククリック（エラー時） | パスワードリセット画面へ遷移           | /auth/forgot-password へ                               |
| ログイン画面へ           | リンククリック（エラー時） | ログイン画面へ遷移                     | /auth/login へ                                         |

### フォーム仕様

| フィールド      | 型     | 必須 | バリデーション                                                   | 初期値 |
| --------------- | ------ | ---- | ---------------------------------------------------------------- | ------ |
| password        | string | ○    | - 必須<br>- 8文字以上128文字以下<br>- 大文字・小文字・数字を含む | 空     |
| passwordConfirm | string | ○    | - 必須<br>- passwordと一致                                       | 空     |

### 画面遷移

- **前画面**: メール内のリンク（外部）
- **次画面**:
  - ログイン画面（設定成功時、「パスワードが変更されました」のメッセージ付き）
  - パスワードリセット画面（トークン無効時）
- **エラー時**:
  - トークン無効：エラー画面表示
  - API エラー：同一画面でエラーメッセージ表示

## 5. API仕様

### 使用するAPI

#### 1. トークン検証

- **エンドポイント**: `GET /api/v1/auth/verify-reset-token?token={token}`
- **注意**: このAPIは現在API設計書に未定義。実装時に追加予定
- **目的**: リセットトークンの有効性確認
- **呼び出しタイミング**: 画面初期表示時

**レスポンス**

```typescript
interface VerifyTokenResponse {
  valid: boolean
  email?: string // 有効な場合のみ（表示用）
}
```

#### 2. パスワード再設定

- **エンドポイント**: `POST /api/v1/auth/password/reset`
- **目的**: 新しいパスワードの設定
- **呼び出しタイミング**: パスワードを変更ボタンクリック時

**リクエスト**

```typescript
interface ResetPasswordRequest {
  token: string
  password: string
}
```

**レスポンス**

```typescript
interface ResetPasswordResponse {
  message: string // "パスワードが正常に変更されました"
}
```

**エラーハンドリング**
| エラーコード | 処理 |
|------------|------|
| 400 | 「パスワードが要件を満たしていません」を表示 |
| 401 | 「このリンクは無効または期限切れです」を表示→エラー画面へ |
| 404 | 「トークンが見つかりません」を表示→エラー画面へ |
| 409 | 「このリンクは既に使用されています」を表示→エラー画面へ |
| 500 | 「システムエラーが発生しました。しばらくしてから再度お試しください」を表示 |

## 6. 状態管理

### クライアント状態

```typescript
interface ResetPasswordState {
  token: string // URLから取得
  tokenValid: boolean
  userEmail?: string
  password: string
  passwordConfirm: string
  showPassword: boolean
  showPasswordConfirm: boolean
  isSubmitting: boolean
  error: string | null
  passwordStrength: {
    hasMinLength: boolean
    hasUpperCase: boolean
    hasLowerCase: boolean
    hasNumber: boolean
  }
}
```

### サーバー状態（TanStack Query）

- **queryKey**: `['auth', 'verify-reset-token', token]`
- **mutationKey**: `['auth', 'reset-password']`
- **キャッシュ戦略**: トークン検証結果はキャッシュしない（セキュリティのため）
- **再検証タイミング**: なし

### URL状態

- **クエリパラメータ**:
  - `token`: リセットトークン（必須）
  - 例: `/auth/reset-password?token=abc123def456...`

## 7. 実装ガイド

### 使用コンポーネント

- **shadcn/ui**:
  - Card, CardHeader, CardContent
  - Input
  - Button
  - Label
  - Alert
  - Skeleton（トークン検証中のローディング）
- **カスタムコンポーネント**:
  - PasswordInput（パスワード表示切替機能付き）
  - PasswordStrengthIndicator（パスワード強度表示）

### ディレクトリ構成

```
src/
├── app/auth/reset-password/
│   └── page.tsx
└── modules/auth/
    └── client/
        ├── components/
        │   ├── ResetPasswordForm.tsx
        │   └── InvalidTokenError.tsx
        └── hooks/
            ├── useVerifyResetToken.ts
            └── useResetPassword.ts
```

### 実装時の注意点

- URLからトークンを取得し、即座に検証を開始
- トークン検証中はローディング表示
- 無効なトークンの場合は、フォームを表示せずエラー画面を表示
- パスワード変更成功後は、成功メッセージと共にログイン画面へ自動リダイレクト（3秒後）
- トークンは一度使用したら無効化される（バックエンド側で制御）
- パスワード強度チェックは新規登録画面と同じロジックを使用

### テスト観点

- [ ] **正常系**:
  - 有効なトークンでアクセス
  - 新しいパスワードの設定成功
  - ログイン画面への自動遷移
  - パスワード強度表示の動作
- [ ] **異常系**:
  - 無効なトークン
  - 期限切れトークン
  - 使用済みトークン
  - パスワード要件不足
  - パスワード不一致
- [ ] **エッジケース**:
  - トークンパラメータなしでのアクセス
  - ログイン済みユーザーのアクセス
  - 極端に長い/短いパスワード
  - ネットワークエラー時の処理
  - トークン検証中の画面離脱
