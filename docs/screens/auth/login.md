# ログイン

## 1. 基本情報

- **画面ID**: SCREEN_AUTH_001
- **パス**: /auth/login
- **作成日**: 2025-06-24
- **更新日**: 2025-06-24
- **ステータス**: 設計中
- **担当者**: @claude

## 2. 画面概要

### 目的

既存ユーザーがシステムにログインし、認証済みセッションを確立するための画面。メールアドレスとパスワードによる認証を提供する。

### ユーザーストーリー

As a 登録済みユーザー
I want to メールアドレスとパスワードでログインする
So that 自分の食材データを管理できる

### 前提条件・制約

- **アクセス権限**: 未認証ユーザーのみ（ログイン済みの場合はホーム画面へリダイレクト）
- **事前条件**: ユーザー登録が完了していること
- **画面の制約事項**:
  - セキュリティのため、ログイン失敗時は「メールアドレスまたはパスワードが正しくありません」と曖昧なメッセージを表示
  - 連続ログイン失敗時のレート制限（5回失敗で15分間ロック）

## 3. UI設計

### 画面構成

```
┌─────────────────────────────────────┐
│       🍳 食材管理アプリ              │
├─────────────────────────────────────┤
│                                     │
│         ログイン                     │
│                                     │
│   ┌─────────────────────────┐      │
│   │ メールアドレス          │      │
│   └─────────────────────────┘      │
│                                     │
│   ┌─────────────────────────┐      │
│   │ パスワード             │👁     │
│   └─────────────────────────┘      │
│                                     │
│   □ ログイン状態を保持する          │
│                                     │
│   [    ログイン    ]               │
│                                     │
│   パスワードを忘れた方はこちら      │
│                                     │
│   ─────────── または ───────────    │
│                                     │
│   アカウントをお持ちでない方        │
│   [  新規登録  ]                   │
│                                     │
└─────────────────────────────────────┘
```

### コンポーネント構成

- **ヘッダー**: アプリロゴとタイトル
- **メイン**:
  - ログインフォーム（メールアドレス、パスワード入力）
  - 「ログイン状態を保持する」チェックボックス
  - ログインボタン
  - パスワードリセットリンク
  - 新規登録への導線
- **フッター**: なし（シンプルな認証画面のため）

### レスポンシブ対応

- **モバイル (< 768px)**: フォーム幅100%、パディング16px
- **タブレット (768px - 1024px)**: フォーム幅400px、中央配置
- **デスクトップ (> 1024px)**: フォーム幅400px、中央配置

## 4. 機能仕様

### アクション一覧

| アクション         | トリガー                         | 処理内容                     | 結果                                                 |
| ------------------ | -------------------------------- | ---------------------------- | ---------------------------------------------------- |
| ログイン           | ログインボタンクリック           | 認証API呼び出し              | 成功：ホーム画面へ遷移<br>失敗：エラーメッセージ表示 |
| パスワード表示切替 | 目アイコンクリック               | パスワードの表示/非表示切替  | 入力内容が見える/隠れる                              |
| パスワードリセット | 「パスワードを忘れた方」クリック | パスワードリセット画面へ遷移 | /auth/forgot-password へ                             |
| 新規登録           | 「新規登録」ボタンクリック       | 新規登録画面へ遷移           | /auth/register へ                                    |

### フォーム仕様

| フィールド | 型      | 必須 | バリデーション                          | 初期値 |
| ---------- | ------- | ---- | --------------------------------------- | ------ |
| email      | string  | ○    | - 必須<br>- メール形式<br>- 最大254文字 | 空     |
| password   | string  | ○    | - 必須<br>- 8文字以上128文字以下        | 空     |
| rememberMe | boolean | ×    | なし                                    | false  |

### 画面遷移

- **前画面**:
  - 各種画面（未認証時のアクセス）
  - 新規登録完了画面
  - パスワードリセット完了画面
- **次画面**:
  - ホーム画面（ログイン成功時）
  - 元々アクセスしようとしていた画面（リダイレクト元がある場合）
- **エラー時**: 同一画面でエラーメッセージ表示

## 5. API仕様

### 使用するAPI

#### 1. ログイン

- **エンドポイント**: `POST /api/v1/auth/login`
- **目的**: ユーザー認証とセッショントークン取得
- **呼び出しタイミング**: ログインボタンクリック時

**リクエスト**

```typescript
interface LoginRequest {
  email: string
  password: string
  rememberMe?: boolean
}
```

**レスポンス**

```typescript
interface LoginResponse {
  user: {
    id: string
    email: string
    displayName: string
    emailVerified: boolean
  }
  session: {
    token: string
    expiresAt: string // ISO 8601
  }
}
```

**エラーハンドリング**
| エラーコード | 処理 |
|------------|------|
| 400 | 「入力内容を確認してください」をフォーム上部に表示 |
| 401 | 「メールアドレスまたはパスワードが正しくありません」を表示 |
| 429 | 「ログイン試行回数が上限に達しました。15分後に再度お試しください」を表示 |
| 500 | 「システムエラーが発生しました。しばらくしてから再度お試しください」を表示 |

## 6. 状態管理

### クライアント状態

```typescript
interface LoginFormState {
  email: string
  password: string
  rememberMe: boolean
  showPassword: boolean
  isSubmitting: boolean
  error: string | null
}
```

### サーバー状態（TanStack Query）

- **mutationKey**: `['auth', 'login']`
- **キャッシュ戦略**: ログイン成功時にユーザー情報をキャッシュ
- **再検証タイミング**: なし（一度きりの操作）

### URL状態

- **クエリパラメータ**:
  - `redirect`: ログイン後のリダイレクト先（オプション）
  - 例: `/auth/login?redirect=/ingredients/list`

## 7. 実装ガイド

### 使用コンポーネント

- **shadcn/ui**:
  - Card, CardHeader, CardContent
  - Input
  - Button
  - Checkbox
  - Label
  - Alert
- **カスタムコンポーネント**:
  - PasswordInput（パスワード表示切替機能付き）

### ディレクトリ構成

```
src/
├── app/auth/login/
│   └── page.tsx
└── modules/auth/
    ├── client/
    │   ├── components/
    │   │   └── LoginForm.tsx
    │   └── hooks/
    │       └── useLogin.ts
    └── shared/
        └── types/
            └── auth.types.ts
```

### 実装時の注意点

- セッショントークンはhttpOnly cookieで管理（XSS対策）
- CSRF対策の実装
- パスワードは平文で送信されるため、HTTPS必須
- ログイン成功後は必要なユーザー情報のみクライアントに保存
- rememberMeがtrueの場合、セッション有効期限を30日に延長

### テスト観点

- [ ] **正常系**:
  - 有効な認証情報でログイン成功
  - リダイレクト先が指定されている場合の遷移
  - rememberMe選択時のセッション期限
- [ ] **異常系**:
  - 無効なメールアドレス形式
  - 間違ったパスワード
  - 存在しないユーザー
  - 連続ログイン失敗によるレート制限
- [ ] **エッジケース**:
  - ログイン済みユーザーのアクセス（ホームへリダイレクト）
  - ネットワークエラー時の処理
  - セッション競合（複数デバイスログイン）
