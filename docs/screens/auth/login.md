# ログイン

## 1. 基本情報

- **画面ID**: SCREEN_AUTH_001
- **パス**: /auth/login
- **作成日**: 2025-06-24
- **更新日**: 2025-06-24
- **ステータス**: 設計中
- **担当者**: @claude

## 2. 画面概要

### 目的

既存ユーザーがシステムにログインし、認証済みセッションを確立するための画面。NextAuthのマジックリンク認証を使用し、メールアドレスのみでセキュアなログインを提供する。

### ユーザーストーリー

As a 登録済みユーザー
I want to メールアドレスでマジックリンクを受け取ってログインする
So that パスワードを覚えることなく安全に自分の食材データを管理できる

### 前提条件・制約

- **アクセス権限**: 未認証ユーザーのみ（ログイン済みの場合はホーム画面へリダイレクト）
- **事前条件**: なし（初回利用時は自動的にユーザー作成）
- **画面の制約事項**:
  - メール送信のレート制限（同一メールアドレスへの送信は5分間に1回まで）
  - マジックリンクの有効期限は15分間

## 3. UI設計

### 画面構成

```
┌─────────────────────────────────────┐
│       🍳 食材管理アプリ              │
├─────────────────────────────────────┤
│                                     │
│         ログイン                     │
│                                     │
│   メールアドレスを入力すると、      │
│   ログイン用のリンクをお送りします  │
│                                     │
│   ┌─────────────────────────┐      │
│   │ メールアドレス          │      │
│   └─────────────────────────┘      │
│                                     │
│   [  マジックリンクを送信  ]       │
│                                     │
│   パスワード不要で安全にログイン    │
│   できます                          │
│                                     │
└─────────────────────────────────────┘
```

### コンポーネント構成

- **ヘッダー**: アプリロゴとタイトル
- **メイン**:
  - 説明文（マジックリンクの仕組み）
  - メールアドレス入力フォーム
  - マジックリンク送信ボタン
  - セキュリティ説明文
- **フッター**: なし（シンプルな認証画面のため）

### レスポンシブ対応

- **モバイル (< 768px)**: フォーム幅100%、パディング16px
- **タブレット (768px - 1024px)**: フォーム幅400px、中央配置
- **デスクトップ (> 1024px)**: フォーム幅400px、中央配置

## 4. 機能仕様

### アクション一覧

| アクション           | トリガー                     | 処理内容                         | 結果                                                     |
| -------------------- | ---------------------------- | -------------------------------- | -------------------------------------------------------- |
| マジックリンク送信   | 送信ボタンクリック           | NextAuth signIn API呼び出し      | 成功：確認画面へ遷移<br>失敗：エラーメッセージ表示       |
| メールアドレス入力   | テキストフィールド入力       | バリデーション実行               | リアルタイムでエラー表示                                 |

### フォーム仕様

| フィールド | 型     | 必須 | バリデーション                          | 初期値 |
| ---------- | ------ | ---- | --------------------------------------- | ------ |
| email      | string | ○    | - 必須<br>- メール形式<br>- 最大254文字 | 空     |

### 画面遷移

- **前画面**:
  - 各種画面（未認証時のアクセス）
  - メール確認画面からのリダイレクト
- **次画面**:
  - メール確認画面（/auth/verify-request）
  - エラー画面（/auth/error）エラー時
- **エラー時**: エラー画面へ遷移またはトースト表示

## 5. API仕様

### 使用するAPI

#### 1. マジックリンク送信（NextAuth Email Provider）

- **エンドポイント**: NextAuth signIn関数（内部的に`/api/auth/signin/email`を使用）
- **目的**: マジックリンクをメールで送信
- **呼び出しタイミング**: マジックリンク送信ボタンクリック時

**実装例**

```typescript
import { signIn } from 'next-auth/react'

// クライアント側での呼び出し
await signIn('email', {
  email: userEmail,
  redirect: false,
  callbackUrl: '/'
})
```

**レスポンス**

```typescript
interface SignInResponse {
  error: string | undefined
  status: number
  ok: boolean
  url: string | null
}
```

**エラーハンドリング**
| エラータイプ | 処理 |
|------------|------|
| EmailSignInError | 「メールの送信に失敗しました」をトースト表示 |
| Configuration | 「システム設定エラーです。管理者にお問い合わせください」を表示 |
| AccessDenied | 「アクセスが拒否されました」を表示 |
| Default | 「エラーが発生しました。しばらくしてから再度お試しください」を表示 |

## 6. 状態管理

### クライアント状態

```typescript
interface LoginFormState {
  email: string
  isSubmitting: boolean
  error: string | null
  emailSent: boolean // メール送信完了フラグ
}
```

### サーバー状態（NextAuth）

- NextAuthのuseSession()フックでセッション管理
- signIn()関数でマジックリンク送信
- セッション状態は自動的に管理される

### URL状態

- **クエリパラメータ**:
  - `callbackUrl`: ログイン後のリダイレクト先（NextAuth標準）
  - `error`: エラーメッセージ（NextAuthからのリダイレクト時）
  - 例: `/auth/login?callbackUrl=/ingredients/list`

## 7. 実装ガイド

### 使用コンポーネント

- **shadcn/ui**:
  - Card, CardHeader, CardContent
  - Input
  - Button
  - Label
  - Alert
  - Toast
- **NextAuth**:
  - signIn関数
  - useSession フック

### ディレクトリ構成

```
src/
├── app/auth/
│   ├── login/
│   │   └── page.tsx
│   ├── verify-request/
│   │   └── page.tsx
│   └── error/
│       └── page.tsx
└── modules/auth/
    ├── client/
    │   ├── components/
    │   │   └── LoginForm.tsx
    │   └── hooks/
    │       └── useMagicLink.ts
    └── shared/
        └── types/
            └── auth.types.ts
```

### 実装時の注意点

- NextAuthがセッション管理を自動的に処理（httpOnly cookie使用）
- CSRF対策はNextAuthに組み込み済み
- マジックリンクはHTTPS環境でのみ使用可能
- メール送信後は確認画面へ自動遷移
- マジックリンクの有効期限は15分（NextAuth設定）
- 同一メールアドレスへの連続送信制限の実装

### テスト観点

- [ ] **正常系**:
  - 有効なメールアドレスでマジックリンク送信成功
  - 確認画面への遷移
  - マジックリンクからのログイン成功
  - callbackUrlが指定されている場合の遷移
- [ ] **異常系**:
  - 無効なメールアドレス形式
  - メール送信エラー
  - 期限切れマジックリンク
  - 連続送信によるレート制限
- [ ] **エッジケース**:
  - ログイン済みユーザーのアクセス（ホームへリダイレクト）
  - ネットワークエラー時の処理
  - 複数デバイスでの同時ログイン
