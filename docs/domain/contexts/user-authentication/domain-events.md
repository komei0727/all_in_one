# ユーザー認証コンテキスト - ドメインイベント仕様

## 概要

このドキュメントでは、ユーザー認証コンテキストで発生するドメインイベントを定義します。
ドメインイベントは、認証・認可に関する重要な出来事を表現し、監査ログ、セキュリティ監視、他コンテキストとの連携に使用されます。

## イベント設計原則

1. **過去形で命名** - 既に起きた事実を表現（例：UserRegistered）
2. **不変性** - イベントは作成後に変更されない
3. **自己完結性** - イベント単体で意味が理解できる情報を含む
4. **時系列性** - 発生時刻を必ず含む

## イベント一覧

### ユーザーライフサイクルイベント

| イベント           | 発生タイミング     | 主要データ                           | 用途                           |
| ------------------ | ------------------ | ------------------------------------ | ------------------------------ |
| UserRegistered     | ユーザー登録時     | ユーザーID、メールアドレス、登録日時 | 監査ログ、ウェルカムメール     |
| UserVerified       | メール確認完了時   | ユーザーID、確認日時                 | アカウント有効化、通知         |
| UserProfileUpdated | プロフィール更新時 | ユーザーID、変更内容                 | 監査ログ、同期                 |
| UserDeactivated    | アカウント無効化時 | ユーザーID、無効化理由、実行者       | 監査ログ、セッション無効化     |
| UserDeleted        | アカウント削除時   | ユーザーID、削除理由                 | 監査ログ、データクリーンアップ |

### 認証イベント

| イベント           | 発生タイミング     | 主要データ                           | 用途                                   |
| ------------------ | ------------------ | ------------------------------------ | -------------------------------------- |
| UserLoggedIn       | ログイン成功時     | ユーザーID、IPアドレス、デバイス情報 | セキュリティ監視、使用統計             |
| UserLoggedOut      | ログアウト時       | ユーザーID、セッションID             | セッション管理、監査ログ               |
| LoginAttemptFailed | ログイン失敗時     | メールアドレス、IPアドレス、失敗理由 | セキュリティ監視、ブルートフォース検知 |
| SessionCreated     | セッション作成時   | セッションID、ユーザーID、有効期限   | セッション追跡                         |
| SessionRevoked     | セッション無効化時 | セッションID、無効化理由             | セキュリティ監査                       |

### パスワード管理イベント

| イベント                  | 発生タイミング           | 主要データ                       | 用途                         |
| ------------------------- | ------------------------ | -------------------------------- | ---------------------------- |
| PasswordChanged           | パスワード変更時         | ユーザーID、変更日時             | セキュリティ通知、監査ログ   |
| PasswordResetRequested    | パスワードリセット要求時 | ユーザーID、要求日時、IPアドレス | メール送信、セキュリティ監視 |
| PasswordResetCompleted    | パスワードリセット完了時 | ユーザーID、完了日時             | 確認通知、監査ログ           |
| PasswordResetTokenExpired | リセットトークン期限切れ | ユーザーID、トークンID           | クリーンアップ               |

### セキュリティイベント

| イベント                    | 発生タイミング           | 主要データ                                 | 用途                                 |
| --------------------------- | ------------------------ | ------------------------------------------ | ------------------------------------ |
| SuspiciousActivityDetected  | 不審なアクティビティ検出 | ユーザーID、アクティビティ詳細、IPアドレス | セキュリティアラート、アカウント保護 |
| AccountLocked               | アカウントロック時       | ユーザーID、ロック理由、期間               | ユーザー通知、サポート対応           |
| AccountUnlocked             | アカウントロック解除時   | ユーザーID、解除理由、実行者               | 監査ログ、通知                       |
| UnauthorizedAccessAttempted | 不正アクセス試行時       | リソース、ユーザーID、IPアドレス           | セキュリティ監視、ログ分析           |

## イベントの共通属性

すべてのドメインイベントは以下の共通属性を持ちます：

| 属性        | 型     | 説明                         | 例                                |
| ----------- | ------ | ---------------------------- | --------------------------------- |
| eventId     | string | イベントの一意識別子         | "evt_01HX5K3J2BXVMH3Z4K5N6P7Q8R"  |
| eventType   | string | イベントタイプ               | "UserRegistered"                  |
| aggregateId | string | 集約ルートのID               | "user_01HX5K3J2BXVMH3Z4K5N6P7Q8R" |
| occurredAt  | Date   | イベント発生時刻             | "2025-06-24T10:30:00Z"            |
| userId      | string | イベントを発生させたユーザー | "user_01HX5K3J2BXVMH3Z4K5N6P7Q8R" |
| metadata    | object | 追加のメタデータ             | { "ipAddress": "192.168.1.1" }    |

## イベント詳細

### UserRegistered

```typescript
interface UserRegistered extends DomainEvent {
  eventType: 'UserRegistered'
  payload: {
    userId: string
    email: string
    displayName: string
    firstName?: string
    lastName?: string
    registrationMethod: 'EMAIL'
    emailVerified: boolean
  }
}
```

### UserLoggedIn

```typescript
interface UserLoggedIn extends DomainEvent {
  eventType: 'UserLoggedIn'
  payload: {
    userId: string
    sessionId: string
    ipAddress: string
    userAgent: string
    loginMethod: 'PASSWORD' | 'SESSION_TOKEN'
  }
}
```

### LoginAttemptFailed

```typescript
interface LoginAttemptFailed extends DomainEvent {
  eventType: 'LoginAttemptFailed'
  payload: {
    email: string
    ipAddress: string
    failureReason: 'INVALID_CREDENTIALS' | 'ACCOUNT_LOCKED' | 'ACCOUNT_NOT_FOUND'
    attemptCount: number
  }
}
```

## イベントの利用パターン

### 1. 監査とコンプライアンス

- すべての認証関連イベントを監査ログとして保存
- 法規制要件に応じた保持期間の設定
- 改ざん防止のための暗号化

### 2. セキュリティ監視

- ログイン失敗の連続検知によるブルートフォース対策
- 異常なアクセスパターンの検出
- リアルタイムアラートの生成

### 3. 他コンテキストへの通知

- 食材管理コンテキスト：ユーザー削除時のデータクリーンアップ
- 通知サービス：重要なセキュリティイベントの通知
- 分析サービス：使用統計の収集

### 4. ユーザー体験の向上

- ログイン履歴の表示
- セキュリティアクティビティの可視化
- 異常検知時の自動保護

## イベントストア設計

### 保存期間

| イベントカテゴリ | 保存期間 | 理由                       |
| ---------------- | -------- | -------------------------- |
| 認証イベント     | 1年      | セキュリティ監査要件       |
| パスワード変更   | 2年      | コンプライアンス要件       |
| アカウント削除   | 7年      | 法的要件                   |
| セッション管理   | 90日     | パフォーマンスとのバランス |

### パフォーマンス考慮

- イベントの非同期発行による応答速度の維持
- 重要度に応じたイベント処理の優先順位付け
- バッチ処理による効率的なイベント集計

## 実装上の注意

1. **個人情報の取り扱い**

   - パスワードは絶対にイベントに含めない
   - 必要最小限の個人情報のみ記録
   - GDPRなどのプライバシー規制の遵守

2. **イベントの順序保証**

   - 同一集約内のイベントは順序を保証
   - 異なる集約間のイベントは結果整合性

3. **エラーハンドリング**
   - イベント発行の失敗がビジネス処理を妨げない
   - 重要イベントは再試行メカニズムを実装

## 更新履歴

| 日付       | 内容     | 作成者 |
| ---------- | -------- | ------ |
| 2025-06-24 | 初版作成 | Claude |
