# ユーザー認証コンテキスト - リポジトリ仕様

## 概要

このドキュメントでは、ユーザー認証コンテキストのリポジトリインターフェースを定義します。
リポジトリは集約の永続化とビジネス要件に基づく検索を責務とし、Supabase Authenticationとの統合も考慮します。

## リポジトリ一覧

| リポジトリ                       | 対象集約/エンティティ      | 主要な責務                 |
| -------------------------------- | -------------------------- | -------------------------- |
| UserRepository                   | ユーザー集約               | ユーザー情報の永続化と検索 |
| UserCredentialRepository         | ユーザー認証情報           | パスワード認証情報の管理   |
| AuthSessionRepository            | 認証セッション             | アクティブセッションの管理 |
| PasswordResetTokenRepository     | パスワードリセットトークン | リセットトークンの管理     |
| EmailVerificationTokenRepository | メール確認トークン         | メール確認トークンの管理   |

## UserRepository

### 基本操作

| メソッド           | 説明                         | 備考                       |
| ------------------ | ---------------------------- | -------------------------- |
| save(user)         | ユーザーの保存（作成・更新） | Supabaseとの同期を含む     |
| findById(id)       | IDによるユーザー取得         | 削除済みは除外             |
| findByEmail(email) | メールアドレスによる取得     | 大文字小文字を区別しない   |
| delete(id)         | ユーザーの削除               | 論理削除、関連データも処理 |

### ビジネス要件に基づく検索

| メソッド                          | 説明                       | 使用場面                 |
| --------------------------------- | -------------------------- | ------------------------ |
| existsByEmail(email)              | メールアドレスの存在確認   | 新規登録時の重複チェック |
| findUnverifiedUsers(days)         | 未確認ユーザーの取得       | リマインダー送信         |
| findInactiveUsers(days)           | 非アクティブユーザーの取得 | アカウント整理           |
| findByIds(ids)                    | 複数IDによる一括取得       | バッチ処理               |
| countByRegistrationDate(from, to) | 期間内の登録者数取得       | 統計・分析               |

### Supabase連携

| メソッド                   | 説明                         | 備考                   |
| -------------------------- | ---------------------------- | ---------------------- |
| syncWithSupabase(user)     | Supabaseとのユーザー情報同期 | 作成・更新時に自動実行 |
| findSupabaseUserId(userId) | SupabaseユーザーIDの取得     | 外部連携用             |

## UserCredentialRepository

### 基本操作

| メソッド                     | 説明                         | 備考                       |
| ---------------------------- | ---------------------------- | -------------------------- |
| save(credential)             | 認証情報の保存（作成・更新） | パスワードはハッシュ化済み |
| findByUserId(userId)         | ユーザーIDによる認証情報取得 | 1:1関係                    |
| updatePassword(userId, hash) | パスワードの更新             | 変更日時も更新             |
| delete(userId)               | 認証情報の削除               | ユーザー削除時に連動       |

### セキュリティ関連

| メソッド                            | 説明                         | 使用場面               |
| ----------------------------------- | ---------------------------- | ---------------------- |
| findPasswordAge(userId)             | パスワード変更からの経過日数 | パスワード期限チェック |
| findUsersWithExpiredPasswords(days) | 期限切れパスワードユーザー   | 強制変更通知           |

## AuthSessionRepository

### 基本操作

| メソッド           | 説明                         | 備考                 |
| ------------------ | ---------------------------- | -------------------- |
| save(session)      | セッションの保存             | トークンは一意       |
| findByToken(token) | トークンによるセッション取得 | アクティブなもののみ |
| findById(id)       | IDによるセッション取得       | 管理用               |
| revoke(id)         | セッションの無効化           | ログアウト時         |
| revokeAll(userId)  | ユーザーの全セッション無効化 | セキュリティ対応     |

### ビジネス要件に基づく検索

| メソッド                      | 説明                           | 使用場面             |
| ----------------------------- | ------------------------------ | -------------------- |
| findActiveByUserId(userId)    | ユーザーのアクティブセッション | セッション管理画面   |
| findByUserIdAndIp(userId, ip) | ユーザー・IP別セッション       | 同一IPからの重複防止 |
| countActiveByUserId(userId)   | アクティブセッション数         | セッション数制限     |
| deleteExpired()               | 期限切れセッションの削除       | 定期クリーンアップ   |

### セキュリティ監査

| メソッド                         | 説明                 | 使用場面         |
| -------------------------------- | -------------------- | ---------------- |
| findRecentByUserId(userId, days) | 最近のセッション履歴 | ログイン履歴表示 |
| findByIpAddress(ip, hours)       | IP別セッション検索   | 不審アクセス検知 |

## PasswordResetTokenRepository

### 基本操作

| メソッド           | 説明                     | 備考                     |
| ------------------ | ------------------------ | ------------------------ |
| save(token)        | トークンの保存           | 既存のものは無効化       |
| findByToken(token) | トークンによる取得       | 有効なもののみ           |
| markAsUsed(id)     | トークンを使用済みにする | パスワードリセット完了時 |
| delete(id)         | トークンの削除           | 期限切れ時               |

### ビジネス要件に基づく検索

| メソッド                          | 説明                     | 使用場面           |
| --------------------------------- | ------------------------ | ------------------ |
| findActiveByUserId(userId)        | ユーザーの有効なトークン | 重複発行防止       |
| countRecentRequests(email, hours) | 最近のリクエスト数       | レート制限         |
| deleteExpired()                   | 期限切れトークンの削除   | 定期クリーンアップ |

## EmailVerificationTokenRepository

### 基本操作

| メソッド           | 説明                     | 備考                     |
| ------------------ | ------------------------ | ------------------------ |
| save(token)        | トークンの保存           | ユーザーごとに1つ        |
| findByToken(token) | トークンによる取得       | 有効なもののみ           |
| markAsVerified(id) | トークンを確認済みにする | メール確認完了時         |
| delete(id)         | トークンの削除           | 確認完了または期限切れ時 |

### ビジネス要件に基づく検索

| メソッド                        | 説明                     | 使用場面       |
| ------------------------------- | ------------------------ | -------------- |
| findActiveByUserId(userId)      | ユーザーの有効なトークン | 再送信処理     |
| findExpiredTokens()             | 期限切れトークン一覧     | クリーンアップ |
| countRecentSends(userId, hours) | 最近の送信回数           | レート制限     |

## 共通仕様

### ページング

すべての一覧取得メソッドは以下のページングオプションを受け付けます：

```typescript
interface PagingOptions {
  page: number // ページ番号（1始まり）
  limit: number // 1ページあたりの件数（最大100）
  sort?: SortOptions // ソート条件
}
```

### ソート

```typescript
interface SortOptions {
  field: string // ソート対象フィールド
  order: 'asc' | 'desc' // ソート順
}
```

### トランザクション

- 複数のリポジトリ操作をまたがる場合はトランザクションを使用
- Supabaseとの同期もトランザクション内で実行
- エラー時は全体をロールバック

## パフォーマンス考慮

### インデックス設計

| テーブル      | インデックス           | 用途                     |
| ------------- | ---------------------- | ------------------------ |
| users         | email (unique)         | メールアドレス検索       |
| users         | created_at             | 統計クエリ               |
| auth_sessions | token (unique)         | トークン検索             |
| auth_sessions | user_id, expires_at    | アクティブセッション検索 |
| auth_sessions | ip_address, created_at | セキュリティ監査         |

### キャッシュ戦略

| 対象                   | キャッシュ期間 | 無効化タイミング       |
| ---------------------- | -------------- | ---------------------- |
| ユーザー基本情報       | 5分            | 更新・削除時           |
| アクティブセッション数 | 1分            | セッション作成・削除時 |
| メールアドレス存在確認 | 10分           | ユーザー作成・削除時   |

### 遅延読み込み

- ユーザープロフィールは必要時のみ読み込み
- セッション履歴は別途取得
- 関連エンティティは明示的に指定時のみJOIN

## 実装上の注意

### エラーハンドリング

- 存在しないリソースへのアクセスは`null`を返す（例外を投げない）
- Supabase APIエラーは適切にラップして上位層に伝播
- データベース接続エラーは再試行機能を実装

### セキュリティ

- SQLインジェクション対策（プリペアドステートメント使用）
- ユーザーIDによるアクセス制御の徹底
- センシティブ情報のログ出力禁止

### データ整合性

- Supabaseとローカルデータベースの整合性維持
- 論理削除されたデータは検索結果から除外
- 外部キー制約による参照整合性の保証

## 更新履歴

| 日付       | 内容     | 作成者 |
| ---------- | -------- | ------ |
| 2025-06-24 | 初版作成 | Claude |
