# ユーザー認証コンテキスト - 集約設計

## 概要

このドキュメントでは、ユーザー認証コンテキストの集約（Aggregate）設計を定義します。
集約境界、集約ルート、不変条件を明確にし、ドメインモデルの整合性を保証します。

## 集約設計の原則

1. **トランザクション整合性** - 集約内の変更は同一トランザクションで完結
2. **境界の明確化** - ビジネス上の一貫性境界に基づいて集約を定義
3. **小さく保つ** - パフォーマンスと保守性のため、集約は必要最小限に
4. **結果整合性の活用** - 集約間の整合性は結果整合性で実現

## 集約一覧

| 集約名                         | 集約ルート             | 責務                             |
| ------------------------------ | ---------------------- | -------------------------------- |
| ユーザー集約                   | User                   | ユーザー情報とプロフィールの管理 |
| ユーザー認証情報集約           | UserCredential         | パスワード認証情報の管理         |
| 認証セッション集約             | AuthSession            | アクティブなセッションの管理     |
| パスワードリセットトークン集約 | PasswordResetToken     | パスワードリセット要求の管理     |
| メール確認トークン集約         | EmailVerificationToken | メールアドレス確認要求の管理     |

## ユーザー集約（User Aggregate）

### 概要

ユーザーの基本情報と状態を管理する中核的な集約。認証システムの中心となる。

### 集約ルート

**User** エンティティ

### 集約に含まれるオブジェクト

- **エンティティ**
  - User（集約ルート）
- **値オブジェクト**
  - UserId
  - Email
  - UserProfile

### 集約境界

```
┌─────────────────────────────────┐
│ User Aggregate                  │
│                                 │
│ ┌─────────────┐                 │
│ │    User     │ ← 集約ルート    │
│ └──────┬──────┘                 │
│        │                        │
│ ┌──────┴───────┬────────────┐   │
│ │    Email     │ UserProfile│   │
│ └──────────────┴────────────┘   │
└─────────────────────────────────┘
```

### 不変条件（Invariants）

1. **メールアドレスの一意性**

   - システム全体でメールアドレスは一意でなければならない
   - 変更時も一意性を保証

2. **プロフィール必須性**

   - UserProfileは必ず存在し、displayNameは必須

3. **論理削除の不可逆性**
   - 一度削除されたユーザーは復活できない
   - deletedAtが設定されたら変更不可

### ビジネスルール

- メール未確認のユーザーは機能制限がある
- プロフィール更新は本人のみ可能
- メールアドレス変更には再確認が必要

### 集約の操作

```typescript
// ユーザー登録
const user = User.register(email, profile)

// メール確認
user.verifyEmail()

// プロフィール更新
user.updateProfile(newProfile)

// アカウント無効化
user.deactivate()
```

## ユーザー認証情報集約（UserCredential Aggregate）

### 概要

ユーザーのパスワード認証情報を安全に管理する集約。セキュリティが最重要。

### 集約ルート

**UserCredential** エンティティ

### 集約に含まれるオブジェクト

- **エンティティ**
  - UserCredential（集約ルート）
- **値オブジェクト**
  - UserId（ユーザー集約への参照）
  - HashedPassword

### 集約境界

```
┌─────────────────────────────────┐
│ UserCredential Aggregate        │
│                                 │
│ ┌──────────────────┐            │
│ │ UserCredential   │ ← 集約ルート│
│ └────────┬─────────┘            │
│          │                      │
│ ┌────────┴──────────┐           │
│ │ HashedPassword   │           │
│ └──────────────────┘           │
└─────────────────────────────────┘
```

### 不変条件（Invariants）

1. **ユーザーとの1:1関係**

   - UserIdは必須かつ一意
   - 一人のユーザーに対して一つの認証情報のみ

2. **パスワードの暗号化**

   - パスワードは必ずハッシュ化されて保存
   - 平文パスワードは保持しない

3. **変更履歴の追跡**
   - passwordChangedAtは必ず記録
   - 変更日時は遡れない

### ビジネスルール

- パスワード変更には現在のパスワード確認が必要
- パスワードポリシーを満たす必要がある
- 定期的なパスワード変更を推奨

### 集約の操作

```typescript
// パスワード検証
credential.verify(plainPassword)

// パスワード更新
credential.updatePassword(newHashedPassword)

// 有効期限チェック
credential.isExpired()
```

## 認証セッション集約（AuthSession Aggregate）

### 概要

アクティブな認証セッションを管理する集約。複数デバイスからのアクセスに対応。

### 集約ルート

**AuthSession** エンティティ

### 集約に含まれるオブジェクト

- **エンティティ**
  - AuthSession（集約ルート）
- **値オブジェクト**
  - SessionId
  - UserId（ユーザー集約への参照）
  - SessionToken
  - IpAddress

### 集約境界

```
┌─────────────────────────────────┐
│ AuthSession Aggregate           │
│                                 │
│ ┌─────────────┐                 │
│ │ AuthSession │ ← 集約ルート    │
│ └──────┬──────┘                 │
│        │                        │
│ ┌──────┴────────┬───────────┐   │
│ │ SessionToken  │ IpAddress │   │
│ └───────────────┴───────────┘   │
└─────────────────────────────────┘
```

### 不変条件（Invariants）

1. **トークンの一意性**

   - SessionTokenはシステム全体で一意
   - 暗号学的に安全な生成が必要

2. **有効期限の必須性**

   - expiresAtは必須で、作成時に設定
   - 有効期限は延長可能だが、最大期限あり

3. **無効化の不可逆性**
   - revokedAtが設定されたセッションは再有効化不可
   - 無効化されたトークンは再利用不可

### ビジネスルール

- ユーザーごとに複数のセッション許可（マルチデバイス対応）
- 同一IPからの重複セッションは制限
- 長期間使用されないセッションは自動無効化

### 集約の操作

```typescript
// セッション有効性確認
session.isValid()

// セッション更新
session.refresh()

// セッション無効化
session.revoke()
```

## パスワードリセットトークン集約（PasswordResetToken Aggregate）

### 概要

パスワードリセット要求を安全に管理する集約。セキュリティと利便性のバランスが重要。

### 集約ルート

**PasswordResetToken** エンティティ

### 集約に含まれるオブジェクト

- **エンティティ**
  - PasswordResetToken（集約ルート）
- **値オブジェクト**
  - UserId（ユーザー集約への参照）

### 集約境界

```
┌─────────────────────────────────┐
│ PasswordResetToken Aggregate    │
│                                 │
│ ┌─────────────────────┐         │
│ │ PasswordResetToken  │← 集約ルート│
│ └─────────────────────┘         │
└─────────────────────────────────┘
```

### 不変条件（Invariants）

1. **ワンタイム使用**

   - トークンは一度だけ使用可能
   - usedAtが設定されたら再使用不可

2. **有効期限の厳格性**

   - 有効期限は1時間以内
   - 期限切れトークンは無効

3. **ユーザーごとの一意性**
   - 同一ユーザーの有効なトークンは1つまで
   - 新規発行時は既存のものを無効化

### ビジネスルール

- トークンは予測不可能な方法で生成
- 使用時にはユーザーの存在確認が必要
- 使用後は全セッションを無効化

### 集約の操作

```typescript
// トークン有効性確認
token.isValid()

// 使用済みマーク
token.markAsUsed()

// 有効期限チェック
token.isExpired()
```

## メール確認トークン集約（EmailVerificationToken Aggregate）

### 概要

メールアドレス確認要求を管理する集約。ユーザー登録プロセスの重要な一部。

### 集約ルート

**EmailVerificationToken** エンティティ

### 集約に含まれるオブジェクト

- **エンティティ**
  - EmailVerificationToken（集約ルート）
- **値オブジェクト**
  - UserId（ユーザー集約への参照）
  - Email

### 集約境界

```
┌─────────────────────────────────┐
│ EmailVerificationToken Aggregate│
│                                 │
│ ┌───────────────────────┐       │
│ │EmailVerificationToken │← 集約ルート│
│ └───────┬───────────────┘       │
│         │                       │
│    ┌────┴────┐                  │
│    │  Email  │                  │
│    └─────────┘                  │
└─────────────────────────────────┘
```

### 不変条件（Invariants）

1. **ワンタイム使用**

   - トークンは一度だけ使用可能
   - usedAtが設定されたら再使用不可

2. **有効期限の設定**

   - 有効期限は24時間
   - 期限切れトークンは無効

3. **メールアドレスの一致**
   - トークンのemailとユーザーのemailは一致必須
   - 確認対象のメールアドレスは変更不可

### ビジネスルール

- ユーザーごとに有効なトークンは1つまで
- 再送信にはレート制限あり
- 確認完了後はユーザーのemailVerifiedを更新

### 集約の操作

```typescript
// トークン有効性確認
token.isValid()

// 使用済みマーク
token.markAsUsed()

// 有効期限チェック
token.isExpired()
```

## 集約間の関係

### 参照関係

```
User ← UserCredential (1:1)
  ↑
  ├── AuthSession (1:n)
  ├── PasswordResetToken (1:0..1)
  └── EmailVerificationToken (1:0..1)
```

### 整合性保証

1. **即時整合性（同一集約内）**

   - 集約内の変更は同一トランザクションで完結
   - 不変条件は常に満たされる

2. **結果整合性（集約間）**
   - ユーザー削除時の関連データクリーンアップ
   - セッション無効化の伝播
   - ドメインイベントによる非同期処理

## リポジトリとの対応

各集約に対して1つのリポジトリが対応：

| 集約                           | リポジトリ                       |
| ------------------------------ | -------------------------------- |
| ユーザー集約                   | UserRepository                   |
| ユーザー認証情報集約           | UserCredentialRepository         |
| 認証セッション集約             | AuthSessionRepository            |
| パスワードリセットトークン集約 | PasswordResetTokenRepository     |
| メール確認トークン集約         | EmailVerificationTokenRepository |

## 集約設計のベストプラクティス

### 1. 小さく保つ

- 各集約は単一の責務に集中
- パフォーマンスを考慮したサイズ設計
- 必要以上に大きくしない

### 2. IDによる参照

- 集約間は直接参照ではなくIDで参照
- 遅延読み込みによるパフォーマンス最適化
- 循環参照の回避

### 3. ドメインイベントの活用

- 集約間の連携はイベント駆動
- 非同期処理による疎結合
- 監査ログとしても活用

### 4. トランザクション境界

- 集約ごとに独立したトランザクション
- 複数集約の更新は結果整合性で対応
- Sagaパターンの適用検討

## パフォーマンス考慮

### 読み込み戦略

1. **集約の完全読み込み**

   - 小さい集約は完全読み込み
   - User、UserCredentialなど

2. **部分読み込み**

   - 大量データを持つ可能性がある集約
   - AuthSession（履歴データ）

3. **遅延読み込み**
   - 関連集約は必要時のみ読み込み
   - IDによる参照を活用

### キャッシュ戦略

| 集約               | キャッシュ期間 | 無効化タイミング |
| ------------------ | -------------- | ---------------- |
| ユーザー集約       | 5分            | 更新時           |
| 認証セッション集約 | 30秒           | 作成・無効化時   |
| トークン系集約     | キャッシュなし | -                |

## 更新履歴

| 日付       | 内容     | 作成者 |
| ---------- | -------- | ------ |
| 2025-06-24 | 初版作成 | Claude |
