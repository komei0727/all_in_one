# 食材管理コンテキスト - アプリケーションサービス仕様

## 概要

このドキュメントでは、食材管理コンテキストのアプリケーションサービスを定義します。
アプリケーションサービスは、ユースケースの実行とドメイン層の調整を責務とします。

## サービス一覧

| サービス                           | 責務                       | 主要なユースケース     |
| ---------------------------------- | -------------------------- | ---------------------- |
| IngredientApplicationService       | 食材管理の主要ユースケース | 登録、更新、削除、検索 |
| InventoryApplicationService        | 在庫関連の操作             | 消費、補充、在庫確認   |
| ExpiryManagementApplicationService | 期限管理の自動化           | 期限チェック、通知生成 |

## IngredientApplicationService

### 主要メソッド

| メソッド          | 説明             | トランザクション |
| ----------------- | ---------------- | ---------------- |
| createIngredient  | 新規食材登録     | 必要             |
| updateIngredient  | 食材情報更新     | 必要             |
| deleteIngredient  | 食材削除（論理） | 必要             |
| getIngredient     | 食材詳細取得     | 読み取り専用     |
| listIngredients   | 食材一覧取得     | 読み取り専用     |
| searchIngredients | 条件検索         | 読み取り専用     |

### ユースケース: 食材登録

**フロー**:

1. 入力データのバリデーション
2. 重複チェック（名前・期限・保存場所）
3. 食材エンティティの生成
4. リポジトリへの保存
5. ドメインイベントの発行（IngredientCreated）
6. レスポンスDTOの生成

**エラーケース**:

- 重複エラー → DuplicateIngredientException
- カテゴリー不存在 → CategoryNotFoundException
- 単位不存在 → UnitNotFoundException

### ユースケース: 食材検索

**検索条件**:

- カテゴリー
- 保存場所
- 期限状態（期限切れ、期限間近）
- 在庫状態（在庫あり、在庫切れ）
- キーワード（部分一致）

**ソート順**:

- 更新日時（デフォルト）
- 名前
- 期限（賞味期限優先）
- 登録日時

## InventoryApplicationService

### 主要メソッド

| メソッド         | 説明             | トランザクション |
| ---------------- | ---------------- | ---------------- |
| consumeStock     | 在庫消費         | 必要             |
| replenishStock   | 在庫補充         | 必要             |
| adjustStock      | 在庫調整         | 必要             |
| checkStock       | 在庫確認         | 読み取り専用     |
| getLowStockItems | 在庫不足食材取得 | 読み取り専用     |

### ユースケース: 在庫消費

**フロー**:

1. 食材の存在確認
2. 在庫量の検証
3. 消費処理（エンティティメソッド呼び出し）
4. 在庫切れチェック
5. ドメインイベントの発行
   - StockConsumed
   - StockDepleted（在庫切れの場合）
6. 履歴記録

**エラーケース**:

- 在庫不足 → InsufficientStockException
- 食材不存在 → IngredientNotFoundException

## ExpiryManagementApplicationService

### 主要メソッド

| メソッド                  | 説明                 | 実行タイミング |
| ------------------------- | -------------------- | -------------- |
| checkExpiringIngredients  | 期限切れ間近チェック | 日次バッチ     |
| processExpiredIngredients | 期限切れ処理         | 日次バッチ     |
| updateExpiryInfo          | 期限更新             | 手動実行       |
| getExpiryStatistics       | 期限統計取得         | オンデマンド   |

### ユースケース: 期限切れ間近チェック

**フロー**:

1. 期限3日以内の食材を抽出
2. 各食材についてイベント発行（IngredientExpiringSoon）
3. 通知サービスへの連携
4. 処理結果の記録

**バッチ設定**:

- 実行時刻: 毎日 8:00
- タイムアウト: 5分
- リトライ: 3回

## 共通仕様

### DTOパターン

**入力DTO（Command）**:

- 必要最小限のデータ
- バリデーションアノテーション付き
- 不変オブジェクト

**出力DTO（Response）**:

- クライアントが必要とする形式
- ドメインモデルの詳細を隠蔽
- null安全性の保証

### エラーハンドリング

| 例外タイプ          | HTTPステータス | 説明               |
| ------------------- | -------------- | ------------------ |
| ValidationException | 400            | 入力検証エラー     |
| NotFoundException   | 404            | リソース不存在     |
| DuplicateException  | 409            | 重複エラー         |
| BusinessException   | 422            | ビジネスルール違反 |
| SystemException     | 500            | システムエラー     |

### トランザクション管理

- 更新系操作は必ずトランザクション内で実行
- 読み取り専用操作はトランザクション不要
- 複数集約の更新は結果整合性で対応

### 権限チェック

- 将来的な実装のためインターフェースを準備
- 現在は全操作を許可（Phase 1）
- Phase 2でユーザー認証を追加

## パフォーマンス最適化

### キャッシュ戦略

- マスタデータ（カテゴリー、単位）は起動時キャッシュ
- 検索結果は5分間キャッシュ
- 更新操作後はキャッシュクリア

### バッチ処理

- 大量データ処理は非同期実行
- 進捗状況の追跡
- 部分的な失敗の許容

## 監査とロギング

### 監査対象

- すべての更新操作
- 誰が、いつ、何を変更したか
- 変更前後の値

### ログレベル

- INFO: 正常な操作完了
- WARN: リトライ可能なエラー
- ERROR: 処理失敗

## 更新履歴

| 日付       | 内容 | 作成者     |
| ---------- | ---- | ---------- |
| 2025-06-24 | 初版 | @komei0727 |
