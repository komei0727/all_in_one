# 食材管理コンテキスト - リポジトリ仕様

## 概要

このドキュメントでは、食材管理コンテキストのリポジトリインターフェースを定義します。
リポジトリは集約の永続化とビジネス要件に基づく検索を責務とします。

## リポジトリ一覧

| リポジトリ           | 対象集約/エンティティ | 主要な責務             |
| -------------------- | --------------------- | ---------------------- |
| IngredientRepository | 食材集約              | 食材の永続化と検索     |
| CategoryRepository   | カテゴリー集約        | カテゴリーマスタの管理 |
| UnitRepository       | 単位集約              | 単位マスタの管理       |

## IngredientRepository

### 基本操作

| メソッド         | 説明                     | 備考                                         |
| ---------------- | ------------------------ | -------------------------------------------- |
| save(ingredient) | 食材の保存（作成・更新） | IDの有無で判断                               |
| findById(id)     | IDによる食材取得         | 存在しない場合はnull、アクセス権チェック必須 |
| findAll()        | 全食材取得               | 削除済みは除外、実装では使用せず             |
| delete(id)       | 食材の削除               | 論理削除、アクセス権チェック必須             |

### ビジネス要件に基づく検索

**重要**: すべての検索メソッドはユーザーIDによるフィルタリングが必須です。これにより、ユーザーは自分の食材のみアクセス可能となります。

| メソッド                                | 説明                       | 使用場面           |
| --------------------------------------- | -------------------------- | ------------------ |
| findByUserId(userId)                    | ユーザー別食材取得         | マイ食材一覧       |
| findByCategory(userId, categoryId)      | ユーザー・カテゴリー別取得 | カテゴリー絞り込み |
| findExpiringSoon(userId, days)          | ユーザーの期限切れ間近取得 | アラート生成       |
| findExpired(userId)                     | ユーザーの期限切れ食材取得 | 廃棄候補表示       |
| findByStorageLocation(userId, location) | ユーザー・保存場所別取得   | 冷蔵庫確認         |
| findOutOfStock(userId)                  | ユーザーの在庫切れ食材取得 | 買い物リスト       |
| findLowStock(userId, threshold)         | ユーザーの在庫不足食材取得 | 補充提案           |

### 一意性チェック

| メソッド                                                                    | 説明                       | 使用場面   |
| --------------------------------------------------------------------------- | -------------------------- | ---------- |
| existsByUserAndNameAndExpiryAndLocation(userId, name, expiryInfo, location) | ユーザー内での重複チェック | 登録時検証 |

### 集計クエリ

| メソッド                              | 説明                       | 使用場面   |
| ------------------------------------- | -------------------------- | ---------- |
| countByUserAndCategory(userId)        | ユーザーのカテゴリー別件数 | 統計表示   |
| countExpiringSoon(userId, days)       | ユーザーの期限切れ間近件数 | バッジ表示 |
| countByUserAndStorageLocation(userId) | ユーザーの保存場所別件数   | 在庫概要   |

## CategoryRepository

### 基本操作

| メソッド       | 説明             | 備考             |
| -------------- | ---------------- | ---------------- |
| save(category) | カテゴリーの保存 | 作成・更新       |
| findById(id)   | IDによる取得     | マスタ参照       |
| findAll()      | 全カテゴリー取得 | 表示順でソート   |
| delete(id)     | カテゴリーの削除 | 使用中は削除不可 |

### ビジネス要件に基づく検索

| メソッド           | 説明           | 使用場面       |
| ------------------ | -------------- | -------------- |
| findByName(name)   | 名前による検索 | 重複チェック   |
| existsByName(name) | 名前の存在確認 | バリデーション |
| hasIngredients(id) | 食材の有無確認 | 削除可否判定   |

## UnitRepository

### 基本操作

| メソッド     | 説明         | 備考             |
| ------------ | ------------ | ---------------- |
| save(unit)   | 単位の保存   | 作成・更新       |
| findById(id) | IDによる取得 | マスタ参照       |
| findAll()    | 全単位取得   | 表示順でソート   |
| delete(id)   | 単位の削除   | 使用中は削除不可 |

### ビジネス要件に基づく検索

| メソッド                           | 説明             | 使用場面       |
| ---------------------------------- | ---------------- | -------------- |
| findByType(type)                   | タイプ別単位取得 | 単位選択UI     |
| findBySymbol(symbol)               | 記号による検索   | 重複チェック   |
| existsByNameOrSymbol(name, symbol) | 存在確認         | バリデーション |
| hasIngredients(id)                 | 食材の有無確認   | 削除可否判定   |

## 共通仕様

### ページング

大量データを扱う可能性があるメソッドはページング対応：

- `findAll()` → `findAll(page, size)`
- `findByCategory()` → `findByCategory(categoryId, page, size)`

### ソート

ビジネス要件に応じたソート順：

- 食材：更新日時降順（デフォルト）、名前昇順、期限昇順（賞味期限優先）
- カテゴリー・単位：表示順昇順

### トランザクション

- 各リポジトリメソッドは単一のトランザクション内で実行
- 複数集約にまたがる操作はアプリケーションサービスで制御

## パフォーマンス考慮事項

### インデックス設計

効率的な検索のためのインデックス：

- 食材：userId, categoryId, expiryInfo（データベース実装ではbest_before_dateとuse_by_dateの個別インデックス）, storageLocation
- カテゴリー：name, displayOrder
- 単位：type, symbol

### キャッシュ戦略

- カテゴリー・単位：アプリケーション起動時に全件キャッシュ
- 食材：キャッシュなし（更新頻度が高いため）

### 遅延読み込み

- 一覧表示時：最小限のフィールドのみ取得
- 詳細表示時：関連データを含めて取得

## 実装上の注意事項

### アクセス制御

すべての食材操作はUserIdによるアクセス制御が必須です。
詳細な実装方針は[ドメインモデル仕様のアクセス制御](./domain-model.md#アクセス制御)を参照してください。

### エラーハンドリング

- データベース接続エラー：リトライ後、例外をスロー
- 一意制約違反：ビジネス例外として処理
- 楽観的ロック：バージョン不整合例外

### 論理削除

- 削除フラグ（deletedAt）による論理削除
- 通常の検索では削除済みデータを除外
- 履歴参照時のみ削除済みデータを含める

## 更新履歴

| 日付       | 内容                                                               | 作成者     |
| ---------- | ------------------------------------------------------------------ | ---------- |
| 2025-06-24 | 初版                                                               | @komei0727 |
| 2025-06-24 | ユーザー認証統合に伴う修正（アクセス制御の明記、インデックス追加） | Claude     |
