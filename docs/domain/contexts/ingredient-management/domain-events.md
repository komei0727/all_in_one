# 食材・在庫管理コンテキスト - ドメインイベント仕様

## 概要

このドキュメントでは、食材・在庫管理コンテキストで発生するドメインイベントを定義します。
ドメインイベントは、ビジネス上の重要な出来事を表現し、コンテキスト間の統合や監査ログ、通知などに使用されます。

## イベント設計原則

1. **過去形で命名** - 既に起きた事実を表現（例：IngredientCreated）
2. **不変性** - イベントは作成後に変更されない
3. **自己完結性** - イベント単体で意味が理解できる情報を含む
4. **時系列性** - 発生時刻を必ず含む

## イベント一覧

### 食材ライフサイクルイベント

| イベント          | 発生タイミング | 主要データ                                                                         | 用途                     |
| ----------------- | -------------- | ---------------------------------------------------------------------------------- | ------------------------ |
| IngredientCreated | 食材登録時     | 食材ID、ユーザーID、名前、カテゴリーID、初期数量、単位ID、期限情報、保存場所、価格 | 監査ログ、統計           |
| IngredientUpdated | 食材情報更新時 | 食材ID、ユーザーID、変更フィールド名、変更前の値、変更後の値                       | 監査ログ、同期           |
| IngredientDeleted | 食材削除時     | 食材ID、ユーザーID、削除理由、削除時の在庫数量                                     | 監査ログ、クリーンアップ |

### 在庫変動イベント

| イベント         | 発生タイミング | 主要データ                                                           | 用途             |
| ---------------- | -------------- | -------------------------------------------------------------------- | ---------------- |
| StockConsumed    | 在庫消費時     | 食材ID、ユーザーID、食材名、消費量、単位ID、消費前の量、消費後の量   | 消費履歴、分析   |
| StockReplenished | 在庫補充時     | 食材ID、ユーザーID、食材名、補充量、単位ID、補充前の量、補充後の量   | 購入履歴、分析   |
| StockDepleted    | 在庫切れ時     | 食材ID、ユーザーID、食材名、カテゴリーID、最終消費時刻               | 買い物リスト生成 |
| StockAdjusted    | 在庫調整時     | 食材ID、ユーザーID、食材名、調整前の量、調整後の量、単位ID、調整理由 | 監査ログ         |

### 期限関連イベント

| イベント               | 発生タイミング | 主要データ                                                                                 | 用途           |
| ---------------------- | -------------- | ------------------------------------------------------------------------------------------ | -------------- |
| IngredientExpiringSoon | 期限3日前      | 食材ID、ユーザーID、食材名、カテゴリーID、期限日、期限タイプ（賞味/消費）、残日数          | 通知、アラート |
| IngredientExpired      | 期限切れ時     | 食材ID、ユーザーID、食材名、カテゴリーID、期限日、期限タイプ（賞味/消費）、在庫数量        | 廃棄提案、統計 |
| ExpiryInfoUpdated      | 期限更新時     | 食材ID、ユーザーID、変更前の賞味期限、変更後の賞味期限、変更前の消費期限、変更後の消費期限 | 監査ログ       |

### 閾値イベント

| イベント         | 発生タイミング | 主要データ                                                           | 用途     |
| ---------------- | -------------- | -------------------------------------------------------------------- | -------- |
| LowStockDetected | 在庫が閾値以下 | 食材ID、ユーザーID、食材名、現在量、単位ID、閾値、不足率             | 補充提案 |
| HighStockWarning | 在庫過多検出時 | 食材ID、ユーザーID、食材名、現在量、単位ID、推奨量、超過率、期限情報 | 消費促進 |

### 買い物サポートイベント

| イベント                 | 発生タイミング   | 主要データ                                                                                                                                 | 用途                         |
| ------------------------ | ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------- |
| ShoppingSessionStarted   | セッション開始時 | セッションID、ユーザーID、開始時刻、デバイスタイプ（MOBILE/TABLET/DESKTOP）、位置情報（オプション: 名前、緯度、経度）                      | 監査ログ、アクティビティ追跡 |
| ItemChecked              | 食材確認時       | セッションID、食材ID、食材名、カテゴリーID、在庫状態（IN_STOCK/OUT_OF_STOCK/LOW_STOCK）、期限状態（FRESH/EXPIRING_SOON/EXPIRED）、確認時刻 | 確認履歴、パターン分析       |
| ShoppingSessionCompleted | セッション完了時 | セッションID、ユーザーID、開始時刻、完了時刻、継続時間（分）、確認件数、確認済み食材IDリスト                                               | 統計、使用パターン分析       |
| ShoppingSessionAbandoned | セッション中断時 | セッションID、ユーザーID、開始時刻、中断時刻、継続時間（分）、確認件数、中断理由（TIMEOUT/USER_ACTION/SYSTEM_ERROR）                       | 改善分析                     |

## イベントの共通属性

すべてのイベントに含まれる属性：

| 属性        | 型     | 説明                                       |
| ----------- | ------ | ------------------------------------------ |
| eventId     | string | イベントの一意識別子                       |
| eventType   | string | イベントの種類                             |
| aggregateId | string | 対象集約のID                               |
| occurredAt  | Date   | イベント発生時刻                           |
| version     | number | イベントバージョン                         |
| metadata    | object | ユーザーID（実行者）、相関ID、IPアドレス等 |

## イベントの利用パターン

### 1. 通知システムへの連携

```
IngredientExpiringSoon → 通知サービス → プッシュ通知/メール
StockDepleted → 買い物リストサービス → リスト自動追加
```

### 2. 分析・レポート

```
StockConsumed → 分析サービス → 消費パターン分析
IngredientExpired → 統計サービス → 廃棄率計算
```

### 3. 他コンテキストとの連携

```
IngredientCreated → レシピ管理 → 利用可能レシピ更新
StockDepleted → 買い物サポート → 在庫状態更新
ShoppingSessionCompleted → 分析サービス → 買い物パターン分析
ItemChecked → クイックアクセスビュー → 最近確認リスト更新
```

### 4. 買い物モードの状態管理

```
ShoppingSessionStarted → 買い物モード有効化 → 読み取り専用アクセス
ItemChecked → 確認履歴蓄積 → 頻度分析・優先表示
ShoppingSessionCompleted → 買い物モード終了 → 通常モード復帰
```

## イベントストア設計

### 保存期間

| イベント種別           | 保存期間 | 理由                 |
| ---------------------- | -------- | -------------------- |
| ライフサイクルイベント | 永続     | 監査証跡             |
| 在庫変動イベント       | 1年      | 年間分析用           |
| 期限関連イベント       | 3ヶ月    | 短期分析用           |
| 閾値イベント           | 1ヶ月    | 一時的な通知         |
| 買い物サポートイベント | 6ヶ月    | 買い物パターン分析用 |

### パフォーマンス考慮

- イベントは追記のみ（更新・削除なし）
- 集約IDによるインデックス
- 発生時刻による時系列インデックス
- イベントタイプによる分類インデックス
- セッションIDによるインデックス（買い物サポートイベント用）
- ユーザーIDによる複合インデックス（高速なユーザー別検索）

## 実装上の注意事項

1. **イベントの粒度** - ビジネス的に意味のある単位で設計
2. **イベント順序** - 同一集約内では順序を保証
3. **イベント再生** - 冪等性を考慮した設計
4. **バージョニング** - 後方互換性を保つ
5. **買い物イベントの特性**
   - ItemCheckedイベントは高頻度で発生するため、バッチ処理も検討
   - セッション中断の自動検出（30分無操作でAbandoned）
   - 確認履歴の集約による分析用データの効率的な生成

## 更新履歴

| 日付       | 内容                                                                 | 作成者     |
| ---------- | -------------------------------------------------------------------- | ---------- |
| 2025-06-24 | 初版                                                                 | @komei0727 |
| 2025-06-24 | ユーザー認証統合に伴う修正（全イベントにユーザーID追加）             | Claude     |
| 2025-06-28 | 買い物サポート機能統合に伴う修正（買い物サポートイベント追加）       | Claude     |
| 2025-07-01 | ShoppingSessionStartedイベントにデバイスタイプと位置情報の詳細を追加 | Claude     |
