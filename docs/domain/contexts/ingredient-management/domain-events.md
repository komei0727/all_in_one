# 食材管理コンテキスト - ドメインイベント仕様

## 概要

このドキュメントでは、食材管理コンテキストで発生するドメインイベントを定義します。
ドメインイベントは、ビジネス上の重要な出来事を表現し、コンテキスト間の統合や監査ログ、通知などに使用されます。

## イベント設計原則

1. **過去形で命名** - 既に起きた事実を表現（例：IngredientCreated）
2. **不変性** - イベントは作成後に変更されない
3. **自己完結性** - イベント単体で意味が理解できる情報を含む
4. **時系列性** - 発生時刻を必ず含む

## イベント一覧

### 食材ライフサイクルイベント

| イベント          | 発生タイミング | 主要データ                         | 用途                     |
| ----------------- | -------------- | ---------------------------------- | ------------------------ |
| IngredientCreated | 食材登録時     | 食材ID、名前、カテゴリー、初期数量 | 監査ログ、統計           |
| IngredientUpdated | 食材情報更新時 | 食材ID、変更内容                   | 監査ログ、同期           |
| IngredientDeleted | 食材削除時     | 食材ID、削除理由                   | 監査ログ、クリーンアップ |

### 在庫変動イベント

| イベント         | 発生タイミング | 主要データ                 | 用途             |
| ---------------- | -------------- | -------------------------- | ---------------- |
| StockConsumed    | 在庫消費時     | 食材ID、消費量、残量       | 消費履歴、分析   |
| StockReplenished | 在庫補充時     | 食材ID、補充量、新残量     | 購入履歴、分析   |
| StockDepleted    | 在庫切れ時     | 食材ID、食材名             | 買い物リスト生成 |
| StockAdjusted    | 在庫調整時     | 食材ID、調整前後の量、理由 | 監査ログ         |

### 期限関連イベント

| イベント               | 発生タイミング | 主要データ                 | 用途           |
| ---------------------- | -------------- | -------------------------- | -------------- |
| IngredientExpiringSoon | 期限3日前      | 食材ID、食材名、残日数     | 通知、アラート |
| IngredientExpired      | 期限切れ時     | 食材ID、食材名、期限日     | 廃棄提案、統計 |
| ExpiryInfoUpdated      | 期限更新時     | 食材ID、変更前後の期限情報 | 監査ログ       |

### 閾値イベント

| イベント         | 発生タイミング | 主要データ             | 用途     |
| ---------------- | -------------- | ---------------------- | -------- |
| LowStockDetected | 在庫が閾値以下 | 食材ID、現在量、閾値   | 補充提案 |
| HighStockWarning | 在庫過多検出時 | 食材ID、現在量、推奨量 | 消費促進 |

## イベントの共通属性

すべてのイベントに含まれる属性：

| 属性        | 型     | 説明                 |
| ----------- | ------ | -------------------- |
| eventId     | string | イベントの一意識別子 |
| eventType   | string | イベントの種類       |
| aggregateId | string | 対象集約のID         |
| occurredAt  | Date   | イベント発生時刻     |
| version     | number | イベントバージョン   |
| metadata    | object | ユーザーID、相関ID等 |

## イベントの利用パターン

### 1. 通知システムへの連携

```
IngredientExpiringSoon → 通知サービス → プッシュ通知/メール
StockDepleted → 買い物リストサービス → リスト自動追加
```

### 2. 分析・レポート

```
StockConsumed → 分析サービス → 消費パターン分析
IngredientExpired → 統計サービス → 廃棄率計算
```

### 3. 他コンテキストとの連携

```
IngredientCreated → レシピ管理 → 利用可能レシピ更新
StockDepleted → 買い物サポート → 在庫状態更新
```

## イベントストア設計

### 保存期間

| イベント種別           | 保存期間 | 理由         |
| ---------------------- | -------- | ------------ |
| ライフサイクルイベント | 永続     | 監査証跡     |
| 在庫変動イベント       | 1年      | 年間分析用   |
| 期限関連イベント       | 3ヶ月    | 短期分析用   |
| 閾値イベント           | 1ヶ月    | 一時的な通知 |

### パフォーマンス考慮

- イベントは追記のみ（更新・削除なし）
- 集約IDによるインデックス
- 発生時刻による時系列インデックス
- イベントタイプによる分類インデックス

## 実装上の注意事項

1. **イベントの粒度** - ビジネス的に意味のある単位で設計
2. **イベント順序** - 同一集約内では順序を保証
3. **イベント再生** - 冪等性を考慮した設計
4. **バージョニング** - 後方互換性を保つ

## 更新履歴

| 日付       | 内容 | 作成者     |
| ---------- | ---- | ---------- |
| 2025-06-24 | 初版 | @komei0727 |
